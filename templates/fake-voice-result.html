{% extends "../templates/base.html" %}
{# 
	Parameter	Description
	CallSid A unique identifier for this call, generated by Twilio.
	AccountSid	Your Twilio account id. It is 34 characters long, and always starts with the letters AC.
	From	The phone number of the party that initiated the call. Formatted with a '+' and country code e.g., +16175551212 (E.164 format). If the call is inbound, then it is the caller's caller ID. If the call is outbound, i.e., initiated via a request to the REST API, then this is the phone number you specify as the caller ID.
	To	The phone number of the called party. Formatted with a '+' and country code e.g., +16175551212 (E.164 format). If the call is inbound, then it's your Twilio phone number. If the call is outbound, then it's the phone number you provided to call.
	CallStatus	A descriptive status for the call. The value is one of queued, ringing, in-progress, completed, busy, failed or no-answer. See the CallStatus section below for more details.
	ApiVersion	The version of the Twilio API used to handle this call. For incoming calls, this is determined by the API version set on the called number. For outgoing calls, this is the API version used by the outgoing call's REST API request.
	Direction	Indicates the direction of the call. In most cases this will be inbound, but if you are using <Dial> it will be outbound-dial.
	ForwardedFrom	This parameter is set only when Twilio receives a forwarded call, but its value depends on the caller's carrier including information when forwarding. Not all carriers support passing this information.	
#}
{% block 'content' %}
	<h1 id="account_information">Inbound Voice Result</h1>
	<div id="content">
		<h2>Phone Number - {{data.PhoneNumber.PhoneNumber}}</h2>
		{% if data.Response %}
			<div id="Response" class="twiml-info">
				<h3>Voice Url</h3>
				<label>Url:</label>{{ data.PhoneNumber.VoiceUrl }}<br>
				<label>Status Code:</label>{{data.Response.status_code}}<br>
				<label>TwiML:</label><textarea>{{data.Response.content}}</textarea>
			</div>
		{% endif %}
		{% if data.FallbackResponse %}
			<div id="FallbackResponse" class="twiml-info">
				<h3>Voice Fallback Url</h3>
				<label>Url:</label>{{ data.PhoneNumber.VoiceFallbackUrl }}<br>
				<label>Status Code:</label>{{data.FallbackResponse.status_code}}<br>
				<label>TwiML:</label><textarea>{{data.FallbackResponse.content}}</textarea>
			</div>
			
		{% endif %}
		{% if data.twiml_object %}
			<h3>Console</h3>
			<textarea name="console" rows="8" cols="40" id="console"></textarea>
			<input name="commandline" id="console_input" value="">
			<p>
				<li>For Gathers, entering a blank response will cause a timeout to occur</l>
				<li>Pauses are noted and echoed</li>
				<li>Recording ask for a duration, 0 will mean the recording did not happen</li>
				<li>Transcriptions, if turned on, will be faked with "lorem ipsum" text</li>
				<li>SMS are sent according the attributes passed in</li>
			</p>
	<script type="text/javascript" charset="utf-8">
		$TwimlSid = '{{data.Twiml.Sid}}';
		$console = $('#console');
		function ajax_call (val) {
			$.ajax({
			  url: '/phone-numbers/twiml/'+$TwimlSid,
			  type: 'POST',
			  data: { 'input': val },
			  dataType: 'json',
			  complete: function(xhr, textStatus) {
				//called when complete
			  },
			  success: function(data, textStatus, xhr) {
				$('#console').html($console.html()+data.Text);
				if(data.TwimlSid != undefined){
					$TwimlSid = data.TwimlSid;
					//Make a new fresh ajax call to the new twiml document and start a fresh from the top of it
					ajax_call('');
				}
			  },
			  error: function(xhr, textStatus, errorThrown) {
				//called when there is an error
			  }
			});
			
		}
	
		$(document).ready(function() {
			$('#console_input').bind('keydown', function(event) {
				if (event.keyCode == 13) {
					ajax_call($(this).val());
				}
			});
			// Make a call to start processing the twiml and displaying the results to the user
			ajax_call('');
		});

		
	</script>
	{% else %}
	Error: {{data.ErrorMessage}}
	{% endif %}
	</div>
{% endblock %}